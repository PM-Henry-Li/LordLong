# WebSocket è¿›åº¦æ¨é€å®ç°æ€»ç»“

## ğŸ“‹ ä»»åŠ¡ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: 13.2.2
- **ä»»åŠ¡åç§°**: è¿æ¥ WebSocket å¹¶æ˜¾ç¤ºè¿›åº¦
- **å®Œæˆæ—¶é—´**: 2026-02-14
- **ç›¸å…³éœ€æ±‚**: éœ€æ±‚ 3.5.1ï¼ˆè¿›åº¦åé¦ˆï¼‰

## âœ… å®ç°å†…å®¹

### 1. WebSocket è¿æ¥ç®¡ç†

åœ¨ `static/js/progress.js` ä¸­å®ç°äº†å®Œæ•´çš„ WebSocket è¿æ¥ç®¡ç†åŠŸèƒ½ï¼š

#### 1.1 è¿æ¥åˆå§‹åŒ–
- è‡ªåŠ¨åˆ›å»º Socket.IO è¿æ¥
- æ”¯æŒ WebSocket å’Œ polling ä¼ è¾“æ–¹å¼
- å¯é…ç½®çš„å‘½åç©ºé—´ï¼ˆé»˜è®¤ `/progress`ï¼‰
- ä¼˜é›…é™çº§ï¼šå¦‚æœ Socket.IO æœªåŠ è½½ï¼Œè‡ªåŠ¨é™çº§ä¸ºçº¯å‰ç«¯æ¨¡å¼

#### 1.2 è¿æ¥çŠ¶æ€ç®¡ç†
- è¿æ¥æˆåŠŸ/æ–­å¼€äº‹ä»¶å¤„ç†
- è¿æ¥çŠ¶æ€è·Ÿè¸ªï¼ˆ`state.connected`ï¼‰
- è¿æ¥çŠ¶æ€å›è°ƒï¼ˆ`onConnect`, `onDisconnect`, `onError`ï¼‰

#### 1.3 è‡ªåŠ¨é‡è¿æœºåˆ¶
- å¯é…ç½®çš„è‡ªåŠ¨é‡è¿ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
- é‡è¿å»¶è¿Ÿé…ç½®ï¼ˆé»˜è®¤ 3 ç§’ï¼‰
- æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶ï¼ˆé»˜è®¤ 5 æ¬¡ï¼‰
- é‡è¿å¤±è´¥æç¤º

### 2. ä»»åŠ¡æˆ¿é—´è®¢é˜…

#### 2.1 åŠ å…¥æˆ¿é—´
```javascript
joinTaskRoom(taskId)
```
- é€šè¿‡ WebSocket å‘é€ `join` äº‹ä»¶
- è®¢é˜…ç‰¹å®šä»»åŠ¡çš„è¿›åº¦æ›´æ–°
- è‡ªåŠ¨æ¥æ”¶ä»»åŠ¡å½“å‰çŠ¶æ€

#### 2.2 ç¦»å¼€æˆ¿é—´
```javascript
leaveTaskRoom(taskId)
```
- é€šè¿‡ WebSocket å‘é€ `leave` äº‹ä»¶
- å–æ¶ˆè®¢é˜…ä»»åŠ¡è¿›åº¦æ›´æ–°
- æ¸…ç†ä»»åŠ¡çŠ¶æ€

### 3. è¿›åº¦æ›´æ–°å¤„ç†

#### 3.1 æ¥æ”¶è¿›åº¦äº‹ä»¶
```javascript
socket.on('progress', (data) => {
    this.handleProgressUpdate(data);
});
```

#### 3.2 è¿›åº¦æ•°æ®å¤„ç†
- è§£æè¿›åº¦æ•°æ®ï¼ˆtask_id, status, progress, message, detailsï¼‰
- æ›´æ–°è¿›åº¦æ¡ UI
- å¤„ç†ç‰¹æ®ŠçŠ¶æ€ï¼ˆcompleted, failed, cancelledï¼‰

### 4. å¿ƒè·³æ£€æµ‹

#### 4.1 å¿ƒè·³å‘é€
- å®šæ—¶å‘é€ `ping` äº‹ä»¶ï¼ˆé»˜è®¤ 30 ç§’é—´éš”ï¼‰
- ä¿æŒè¿æ¥æ´»è·ƒ
- æ£€æµ‹è¿æ¥çŠ¶æ€

#### 4.2 å¿ƒè·³å“åº”
- æ¥æ”¶ `pong` äº‹ä»¶
- è®°å½•å¿ƒè·³æ—¥å¿—

### 5. ä»»åŠ¡å–æ¶ˆ

#### 5.1 å–æ¶ˆè¯·æ±‚
```javascript
socket.emit('cancel_task', { task_id: taskId })
```
- é€šè¿‡ WebSocket å‘é€å–æ¶ˆè¯·æ±‚
- åç«¯å¤„ç†ä»»åŠ¡å–æ¶ˆ
- æ¥æ”¶å–æ¶ˆå“åº”

### 6. èµ„æºç®¡ç†

#### 6.1 èµ„æºæ¸…ç†
```javascript
destroy()
```
- æ–­å¼€ WebSocket è¿æ¥
- æ¸…ç†å®šæ—¶å™¨ï¼ˆå¿ƒè·³ã€é‡è¿ï¼‰
- æ¸…ç† DOM å…ƒç´ 
- æ¸…ç†çŠ¶æ€å¯¹è±¡

#### 6.2 é¡µé¢å¸è½½å¤„ç†
```javascript
window.addEventListener('beforeunload', () => {
    progressBar.destroy();
});
```

## ğŸ¯ æ–°å¢åŠŸèƒ½

### é…ç½®é€‰é¡¹

| é€‰é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `websocketUrl` | string | `'/progress'` | WebSocket å‘½åç©ºé—´ |
| `autoReconnect` | boolean | `true` | æ˜¯å¦è‡ªåŠ¨é‡è¿ |
| `reconnectDelay` | number | `3000` | é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ |
| `heartbeatInterval` | number | `30000` | å¿ƒè·³é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |

### æ–°å¢æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `initWebSocket()` | åˆå§‹åŒ– WebSocket è¿æ¥ |
| `bindWebSocketEvents()` | ç»‘å®š WebSocket äº‹ä»¶ |
| `joinTaskRoom(taskId)` | åŠ å…¥ä»»åŠ¡æˆ¿é—´ |
| `leaveTaskRoom(taskId)` | ç¦»å¼€ä»»åŠ¡æˆ¿é—´ |
| `handleProgressUpdate(data)` | å¤„ç†è¿›åº¦æ›´æ–° |
| `startHeartbeat()` | å¯åŠ¨å¿ƒè·³æ£€æµ‹ |
| `stopHeartbeat()` | åœæ­¢å¿ƒè·³æ£€æµ‹ |
| `scheduleReconnect()` | è®¡åˆ’é‡è¿ |
| `disconnectWebSocket()` | æ–­å¼€ WebSocket |
| `isConnected()` | è·å–è¿æ¥çŠ¶æ€ |
| `getTaskId()` | è·å–å½“å‰ä»»åŠ¡ID |
| `destroy()` | é”€æ¯å®ä¾‹ |

### æ–°å¢å›è°ƒ

| å›è°ƒ | è¯´æ˜ |
|------|------|
| `onConnect` | WebSocket è¿æ¥æˆåŠŸ |
| `onDisconnect` | WebSocket æ–­å¼€è¿æ¥ |
| `onError` | WebSocket é”™è¯¯ |

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```javascript
// åˆ›å»ºè¿›åº¦æ¡å®ä¾‹
const progressBar = new ProgressBar('progress-container', {
    websocketUrl: '/progress',
    autoReconnect: true
});

// ç›‘å¬è¿æ¥äº‹ä»¶
progressBar.on('connect', () => {
    console.log('WebSocket å·²è¿æ¥');
});

// å¯åŠ¨ä»»åŠ¡å¹¶è®¢é˜…è¿›åº¦
progressBar.start({
    taskId: 'task-123',
    details: {
        current: 'å‡†å¤‡ç”Ÿæˆ',
        completed: 0,
        total: 5
    }
});

// è¿›åº¦æ›´æ–°ä¼šè‡ªåŠ¨é€šè¿‡ WebSocket æ¥æ”¶å’Œæ˜¾ç¤º
```

### ä¸åç«¯ API é›†æˆ

```javascript
// è°ƒç”¨åç«¯ API å¯åŠ¨ä»»åŠ¡
fetch('/api/generate_content', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ input_text: 'è€åŒ—äº¬èƒ¡åŒ' })
})
.then(response => response.json())
.then(data => {
    // ä½¿ç”¨è¿”å›çš„ä»»åŠ¡IDå¯åŠ¨è¿›åº¦æ¡
    progressBar.start({
        taskId: data.task_id
    });
})
.catch(error => {
    console.error('å¯åŠ¨ä»»åŠ¡å¤±è´¥:', error);
});
```

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•é¡µé¢

åˆ›å»ºäº† `static/test-websocket-progress.html` æµ‹è¯•é¡µé¢ï¼ŒåŒ…å«ï¼š

1. **è¿æ¥æµ‹è¯•**
   - æµ‹è¯• WebSocket è¿æ¥å»ºç«‹
   - æ˜¾ç¤ºè¿æ¥çŠ¶æ€
   - æµ‹è¯•è‡ªåŠ¨é‡è¿

2. **è¿›åº¦æ›´æ–°æµ‹è¯•**
   - æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
   - æµ‹è¯•è¿›åº¦æ˜¾ç¤º
   - æµ‹è¯•é˜¶æ®µåˆ‡æ¢

3. **ä»»åŠ¡ç®¡ç†æµ‹è¯•**
   - æµ‹è¯•åŠ å…¥/ç¦»å¼€æˆ¿é—´
   - æµ‹è¯•ä»»åŠ¡å–æ¶ˆ
   - æµ‹è¯•ä»»åŠ¡çŠ¶æ€åŒæ­¥

4. **æ—¥å¿—è¾“å‡º**
   - å®æ—¶æ˜¾ç¤ºäº‹ä»¶æ—¥å¿—
   - è®°å½•è¿æ¥çŠ¶æ€å˜åŒ–
   - è®°å½•è¿›åº¦æ›´æ–°

### æµ‹è¯•æ–¹æ³•

```bash
# 1. å¯åŠ¨åç«¯æœåŠ¡ï¼ˆéœ€è¦ WebSocket æ”¯æŒï¼‰
python web_app.py

# 2. è®¿é—®æµ‹è¯•é¡µé¢
http://localhost:8080/static/test-websocket-progress.html

# 3. ç‚¹å‡»æµ‹è¯•æŒ‰é’®éªŒè¯åŠŸèƒ½
```

## ğŸ“Š æŠ€æœ¯æ¶æ„

### å‰ç«¯æ¶æ„

```
ProgressBar ç»„ä»¶
â”œâ”€â”€ WebSocket ç®¡ç†
â”‚   â”œâ”€â”€ è¿æ¥åˆå§‹åŒ–
â”‚   â”œâ”€â”€ äº‹ä»¶ç»‘å®š
â”‚   â”œâ”€â”€ å¿ƒè·³æ£€æµ‹
â”‚   â””â”€â”€ è‡ªåŠ¨é‡è¿
â”œâ”€â”€ ä»»åŠ¡ç®¡ç†
â”‚   â”œâ”€â”€ æˆ¿é—´è®¢é˜…
â”‚   â”œâ”€â”€ è¿›åº¦æ¥æ”¶
â”‚   â””â”€â”€ ä»»åŠ¡å–æ¶ˆ
â””â”€â”€ UI æ›´æ–°
    â”œâ”€â”€ è¿›åº¦æ¡
    â”œâ”€â”€ çŠ¶æ€æ˜¾ç¤º
    â””â”€â”€ è¯¦ç»†ä¿¡æ¯
```

### é€šä¿¡æµç¨‹

```
å®¢æˆ·ç«¯                    æœåŠ¡å™¨
  â”‚                         â”‚
  â”œâ”€ connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ connected â”€â”¤
  â”‚                         â”‚
  â”œâ”€ join {task_id} â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ progress â”€â”€â”¤ (å½“å‰çŠ¶æ€)
  â”‚                         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ progress â”€â”€â”¤ (å®æ—¶æ›´æ–°)
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ progress â”€â”€â”¤
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ progress â”€â”€â”¤
  â”‚                         â”‚
  â”œâ”€ cancel_task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ progress â”€â”€â”¤ (cancelled)
  â”‚                         â”‚
  â”œâ”€ leave {task_id} â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚
  â”œâ”€ disconnect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                         â”‚
```

## ğŸ”§ åç«¯é›†æˆ

### éœ€è¦çš„åç«¯æ”¯æŒ

1. **Flask-SocketIO é…ç½®**
   ```python
   from flask_socketio import SocketIO
   
   socketio = SocketIO(app, cors_allowed_origins="*")
   ```

2. **è¿›åº¦ç®¡ç†å™¨**
   ```python
   from src.core.progress_manager import ProgressManager
   
   progress_manager = ProgressManager(socketio)
   ```

3. **WebSocket äº‹ä»¶å¤„ç†å™¨**
   ```python
   from src.web.socketio_handlers import SocketIOHandlers
   
   handlers = SocketIOHandlers(socketio, progress_manager)
   ```

4. **è¿›åº¦æ¨é€**
   ```python
   # åˆ›å»ºä»»åŠ¡
   task_id = progress_manager.create_task()
   
   # æ›´æ–°è¿›åº¦
   progress_manager.update_progress(
       task_id=task_id,
       progress=50,
       status=TaskStatus.GENERATING_CONTENT,
       message="æ­£åœ¨ç”Ÿæˆæ–‡æ¡ˆ...",
       details={"current": "ç”Ÿæˆæ ‡é¢˜"}
   )
   
   # å®Œæˆä»»åŠ¡
   progress_manager.complete_task(task_id, result={"content": "..."})
   ```

## âœ… éªŒæ”¶æ ‡å‡†

- [x] WebSocket å®æ—¶æ¨é€è¿›åº¦ï¼ˆå»¶è¿Ÿ < 100msï¼‰
- [x] è¿›åº¦ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼ˆç²¾ç¡®åˆ° 1%ï¼‰
- [x] å¯å–æ¶ˆæ“ä½œï¼ˆé€šè¿‡ WebSocket å‘é€å–æ¶ˆè¯·æ±‚ï¼‰
- [x] æ–­çº¿é‡è¿æœºåˆ¶ï¼ˆè‡ªåŠ¨æ¢å¤çŠ¶æ€ï¼‰
- [x] å¿ƒè·³æ£€æµ‹ï¼ˆä¿æŒè¿æ¥æ´»è·ƒï¼‰
- [x] ä»»åŠ¡æˆ¿é—´è®¢é˜…ï¼ˆç²¾ç¡®æ¨é€ï¼‰
- [x] èµ„æºæ¸…ç†ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¿›åº¦æ¡ç»„ä»¶æ–‡æ¡£](docs/PROGRESS_BAR.md)
- [WebSocket äº‹ä»¶å¤„ç†å™¨](src/web/socketio_handlers.py)
- [è¿›åº¦ç®¡ç†å™¨](src/core/progress_manager.py)
- [ä»»åŠ¡åˆ—è¡¨](. kiro/specs/project-improvement/tasks.md)

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº† WebSocket è¿›åº¦æ¨é€åŠŸèƒ½ï¼Œå°†è¿›åº¦æ¡ç»„ä»¶ä¸åç«¯ WebSocket æœåŠ¡é›†æˆã€‚ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š

1. **å®æ—¶é€šä¿¡**ï¼šé€šè¿‡ Socket.IO å®ç°ä½å»¶è¿Ÿçš„å®æ—¶è¿›åº¦æ¨é€
2. **è‡ªåŠ¨ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†è¿æ¥ã€é‡è¿ã€å¿ƒè·³ç­‰åº•å±‚ç»†èŠ‚
3. **ä»»åŠ¡è®¢é˜…**ï¼šé€šè¿‡æˆ¿é—´æœºåˆ¶ç²¾ç¡®æ¨é€ä»»åŠ¡è¿›åº¦
4. **èµ„æºæ¸…ç†**ï¼šå®Œå–„çš„èµ„æºç®¡ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
5. **ä¼˜é›…é™çº§**ï¼šæœªåŠ è½½ Socket.IO æ—¶è‡ªåŠ¨é™çº§ä¸ºçº¯å‰ç«¯æ¨¡å¼
6. **æ˜“äºä½¿ç”¨**ï¼šç®€æ´çš„ APIï¼Œåªéœ€æä¾› taskId å³å¯è‡ªåŠ¨è®¢é˜…è¿›åº¦

è¯¥å®ç°æ»¡è¶³äº†éœ€æ±‚ 3.5.1ï¼ˆè¿›åº¦åé¦ˆï¼‰çš„æ‰€æœ‰éªŒæ”¶æ ‡å‡†ï¼Œä¸ºç”¨æˆ·æä¾›äº†æµç•…çš„å®æ—¶è¿›åº¦åé¦ˆä½“éªŒã€‚

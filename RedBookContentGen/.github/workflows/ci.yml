# -*- coding: utf-8 -*-
# GitHub Actions CI/CD å·¥ä½œæµé…ç½®

name: CI

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œ Flake8 æ£€æŸ¥
        run: |
          flake8 src/ --count --show-source --statistics
        continue-on-error: true  # Flake8 å¤±è´¥ä¸é˜»æ­¢æ„å»º
      
      - name: è¿è¡Œ Pylint æ£€æŸ¥
        run: |
          pylint src/ --exit-zero --output-format=text
        continue-on-error: true  # Pylint å¤±è´¥ä¸é˜»æ­¢æ„å»º
  
  # ç±»å‹æ£€æŸ¥ï¼ˆå…³é”®æ­¥éª¤ï¼‰
  type-check:
    name: ç±»å‹æ£€æŸ¥ (mypy)
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œ mypy ç±»å‹æ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å§‹ mypy ç±»å‹æ£€æŸ¥..."
          mypy src/ --config-file=mypy.ini
          echo "âœ… mypy ç±»å‹æ£€æŸ¥é€šè¿‡ï¼"
        # æ³¨æ„ï¼šä¸ä½¿ç”¨ continue-on-errorï¼Œç±»å‹æ£€æŸ¥å¤±è´¥å°†å¯¼è‡´æ„å»ºå¤±è´¥
  
  # å•å…ƒæµ‹è¯•
  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [type-check]  # ç±»å‹æ£€æŸ¥é€šè¿‡åæ‰è¿è¡Œæµ‹è¯•
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei fonts-wqy-zenhei
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term-missing
        env:
          # æµ‹è¯•ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨ mock å€¼ï¼‰
          OPENAI_API_KEY: "test-key-for-ci"
      
      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true  # ä¸Šä¼ å¤±è´¥ä¸å½±å“æ„å»º
  
  # é›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼Œéœ€è¦ API Keyï¼‰
  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-wqy-microhei fonts-wqy-zenhei
      
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          pytest tests/integration/ -v -m "not api" --cov=src --cov-report=term-missing
        continue-on-error: true  # é›†æˆæµ‹è¯•å¤±è´¥ä¸é˜»æ­¢æ„å»º
  
  # æ„å»ºæ£€æŸ¥
  build:
    name: æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [type-check, test]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: æ£€æŸ¥å¯¼å…¥
        run: |
          python -c "import src.content_generator; import src.image_generator; import src.core.config_manager"
          echo "âœ… æ‰€æœ‰æ¨¡å—å¯¼å…¥æˆåŠŸï¼"
      
      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶
        run: |
          python -c "from src.core.config_manager import ConfigManager; cm = ConfigManager(); print('âœ… é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸï¼')"
      
      - name: æ„å»ºæˆåŠŸ
        run: |
          echo "ğŸ‰ æ„å»ºæ£€æŸ¥é€šè¿‡ï¼"
          echo "âœ… ç±»å‹æ£€æŸ¥: é€šè¿‡"
          echo "âœ… å•å…ƒæµ‹è¯•: é€šè¿‡"
          echo "âœ… æ¨¡å—å¯¼å…¥: é€šè¿‡"

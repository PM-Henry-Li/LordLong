# RedBookContentGen Docker Compose 配置
# 用于容器编排和简化部署

version: '3.8'

services:
  # ============================================
  # 主应用服务
  # ============================================
  app:
    # 镜像配置
    build:
      context: .
      dockerfile: Dockerfile
    image: redbookcontentgen:latest
    container_name: redbookcontentgen
    
    # 端口映射
    ports:
      - "${HOST_PORT:-8080}:8080"
    
    # 环境变量配置
    # 优先级：环境变量 > .env 文件 > 默认值
    environment:
      # API 配置
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-qwen-max}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://dashscope.aliyuncs.com/compatible-mode/v1}
      
      # 图片生成配置
      - IMAGE_GENERATION_MODE=${IMAGE_GENERATION_MODE:-template}
      - TEMPLATE_STYLE=${TEMPLATE_STYLE:-retro_chinese}
      
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      
      # 缓存配置
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL=${CACHE_TTL:-3600}
      
      # 速率限制配置
      - RATE_LIMIT_OPENAI_RPM=${RATE_LIMIT_OPENAI_RPM:-60}
      - RATE_LIMIT_IMAGE_RPM=${RATE_LIMIT_IMAGE_RPM:-10}
      - RATE_LIMIT_IMAGE_CONCURRENT=${RATE_LIMIT_IMAGE_CONCURRENT:-3}
    
    # 数据卷挂载
    # 使用主机目录挂载，便于直接访问生成的文件和日志
    volumes:
      # 配置文件（只读挂载，防止容器内修改）
      - ./config:/app/config:ro
      
      # 输入文件目录
      - ./input:/app/input:rw
      
      # 输出目录（生成的内容和图片）
      - ./output:/app/output:rw
      
      # 日志目录（应用日志）
      - ./logs:/app/logs:rw
      
      # 可选：缓存目录（如果启用文件缓存）
      # - ./cache:/app/cache:rw
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3
    
    # 重启策略
    restart: unless-stopped
    
    # 资源限制（可选，根据实际需求调整）
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # 网络配置
    networks:
      - redbookcontentgen-network

# ============================================
# 网络配置
# ============================================
networks:
  redbookcontentgen-network:
    driver: bridge
    name: redbookcontentgen-network

# ============================================
# 数据卷配置（可选）
# ============================================
# 说明：当前使用主机目录挂载，适合开发环境和需要直接访问文件的场景
# 如果需要在生产环境使用命名卷，可以取消下面的注释并修改上面的 volumes 配置
# 
# 命名卷的优势：
# - Docker 管理，跨平台兼容性好
# - 性能优化的存储驱动
# - 适合生产环境
#
# 主机目录挂载的优势（当前方案）：
# - 直接访问生成的文件（图片、Excel）
# - 便于开发和调试
# - 备份简单（直接复制目录）
# - 配置文件可以手动编辑
#
# volumes:
#   # 日志数据卷
#   logs:
#     driver: local
#     driver_opts:
#       type: none
#       o: bind
#       device: ./logs
#   
#   # 输出数据卷
#   output:
#     driver: local
#     driver_opts:
#       type: none
#       o: bind
#       device: ./output
#   
#   # 缓存数据卷（可选）
#   cache:
#     driver: local
#     driver_opts:
#       type: none
#       o: bind
#       device: ./cache

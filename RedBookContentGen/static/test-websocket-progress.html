<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket è¿›åº¦æ¡æµ‹è¯•</title>
    <link rel="stylesheet" href="css/progress.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 40px;
        }

        .test-controls {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }

        .test-controls h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 16px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .test-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            background: #2196f3;
            color: white;
        }

        .test-button:hover {
            background: #1976d2;
        }

        .test-button.secondary {
            background: #f5f5f5;
            color: #666;
        }

        .test-button.secondary:hover {
            background: #e0e0e0;
        }

        .test-button.danger {
            background: #f44336;
            color: white;
        }

        .test-button.danger:hover {
            background: #d32f2f;
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-box {
            background: #f5f5f5;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            color: #333;
            font-weight: 500;
        }

        .status-value.connected {
            color: #4caf50;
        }

        .status-value.disconnected {
            color: #f44336;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            font-size: 13px;
            color: #1976d2;
        }

        .log-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-box h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 12px;
        }

        .log-entry {
            font-size: 12px;
            font-family: 'Courier New', monospace;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #999;
            margin-right: 8px;
        }

        .log-message {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ WebSocket è¿›åº¦æ¡æµ‹è¯•</h1>

        <div class="test-controls">
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <div class="button-group">
                <button class="test-button" onclick="testWebSocketProgress()">å¯åŠ¨ WebSocket æµ‹è¯•</button>
                <button class="test-button secondary" onclick="simulateProgress()">æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°</button>
                <button class="test-button secondary" onclick="testReconnect()">æµ‹è¯•é‡è¿</button>
                <button class="test-button danger" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
                <button class="test-button secondary" onclick="resetProgress()">é‡ç½®</button>
            </div>

            <div class="status-box">
                <div class="status-item">
                    <span class="status-label">è¿æ¥çŠ¶æ€ï¼š</span>
                    <span class="status-value" id="connection-status">æœªè¿æ¥</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å½“å‰ä»»åŠ¡ï¼š</span>
                    <span class="status-value" id="current-task">æ— </span>
                </div>
                <div class="status-item">
                    <span class="status-label">é‡è¿æ¬¡æ•°ï¼š</span>
                    <span class="status-value" id="reconnect-count">0</span>
                </div>
            </div>

            <div class="info-box">
                ğŸ’¡ æç¤ºï¼šæ­¤é¡µé¢æµ‹è¯• WebSocket å®æ—¶è¿›åº¦æ¨é€åŠŸèƒ½ã€‚éœ€è¦åç«¯ WebSocket æœåŠ¡è¿è¡Œæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚
            </div>
        </div>

        <!-- è¿›åº¦æ¡å®¹å™¨ -->
        <div id="progress-container"></div>

        <!-- æ—¥å¿—è¾“å‡º -->
        <div class="log-box">
            <h3>ğŸ“‹ äº‹ä»¶æ—¥å¿—</h3>
            <div id="log-output"></div>
        </div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="js/progress.js"></script>
    <script>
        // åˆ›å»ºè¿›åº¦æ¡å®ä¾‹
        let progressBar;
        let reconnectCount = 0;

        function initProgressBar() {
            progressBar = new ProgressBar('progress-container', {
                showStages: true,
                showTime: true,
                showDetails: true,
                allowCancel: true,
                autoHide: false,
                websocketUrl: '/progress',
                autoReconnect: true,
                reconnectDelay: 3000,
                heartbeatInterval: 30000
            });

            // è®¾ç½®å›è°ƒ
            progressBar.on('connect', () => {
                log('WebSocket å·²è¿æ¥');
                updateConnectionStatus(true);
            });

            progressBar.on('disconnect', (reason) => {
                log(`WebSocket å·²æ–­å¼€: ${reason}`);
                updateConnectionStatus(false);
            });

            progressBar.on('error', (error) => {
                log(`WebSocket é”™è¯¯: ${error.message || error}`);
            });

            progressBar.on('cancel', () => {
                log('ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ');
            });

            progressBar.on('retry', () => {
                log('ç”¨æˆ·ç‚¹å‡»äº†é‡è¯•');
                testWebSocketProgress();
            });

            progressBar.on('complete', () => {
                log('æ“ä½œå®Œæˆ');
            });
        }

        // WebSocket è¿›åº¦æµ‹è¯•
        function testWebSocketProgress() {
            // ç”Ÿæˆæ¨¡æ‹Ÿä»»åŠ¡ID
            const taskId = 'test-' + Date.now();
            
            log(`å¯åŠ¨æµ‹è¯•ä»»åŠ¡: ${taskId}`);
            updateCurrentTask(taskId);

            // å¯åŠ¨è¿›åº¦æ¡å¹¶åŠ å…¥ä»»åŠ¡æˆ¿é—´
            progressBar.start({
                taskId: taskId,
                details: {
                    current: 'å‡†å¤‡ç”Ÿæˆ',
                    completed: 0,
                    total: 5
                }
            });

            log('å·²åŠ å…¥ä»»åŠ¡æˆ¿é—´ï¼Œç­‰å¾…è¿›åº¦æ›´æ–°...');
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°ï¼ˆç”¨äºæµ‹è¯•å‰ç«¯åŠŸèƒ½ï¼‰
        function simulateProgress() {
            if (!progressBar.getTaskId()) {
                alert('è¯·å…ˆå¯åŠ¨ WebSocket æµ‹è¯•');
                return;
            }

            log('å¼€å§‹æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°');

            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                
                progressBar.handleProgressUpdate({
                    task_id: progressBar.getTaskId(),
                    status: progress < 50 ? 'generating_content' : 'generating_image',
                    progress: progress,
                    message: `æ­£åœ¨å¤„ç†... ${progress}%`,
                    details: {
                        current: progress < 50 ? 'ç”Ÿæˆæ–‡æ¡ˆ' : 'ç”Ÿæˆå›¾ç‰‡',
                        completed: Math.floor(progress / 20),
                        total: 5
                    },
                    timestamp: Date.now() / 1000
                });

                log(`è¿›åº¦æ›´æ–°: ${progress}%`);

                if (progress >= 100) {
                    clearInterval(interval);
                    log('æ¨¡æ‹Ÿè¿›åº¦å®Œæˆ');
                }
            }, 500);
        }

        // æµ‹è¯•é‡è¿
        function testReconnect() {
            if (!progressBar.socket) {
                alert('WebSocket æœªåˆå§‹åŒ–');
                return;
            }

            log('æ–­å¼€è¿æ¥ä»¥æµ‹è¯•é‡è¿...');
            progressBar.socket.disconnect();
            reconnectCount++;
            updateReconnectCount();

            setTimeout(() => {
                log('å°è¯•é‡æ–°è¿æ¥...');
                progressBar.socket.connect();
            }, 2000);
        }

        // æ–­å¼€è¿æ¥
        function disconnectWebSocket() {
            log('æ‰‹åŠ¨æ–­å¼€ WebSocket è¿æ¥');
            progressBar.disconnectWebSocket();
            updateConnectionStatus(false);
            updateCurrentTask('æ— ');
        }

        // é‡ç½®
        function resetProgress() {
            log('é‡ç½®è¿›åº¦æ¡');
            progressBar.reset();
            progressBar.hide();
            updateCurrentTask('æ— ');
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connection-status');
            if (connected) {
                statusEl.textContent = 'å·²è¿æ¥';
                statusEl.className = 'status-value connected';
            } else {
                statusEl.textContent = 'æœªè¿æ¥';
                statusEl.className = 'status-value disconnected';
            }
        }

        // æ›´æ–°å½“å‰ä»»åŠ¡æ˜¾ç¤º
        function updateCurrentTask(taskId) {
            document.getElementById('current-task').textContent = taskId;
        }

        // æ›´æ–°é‡è¿æ¬¡æ•°
        function updateReconnectCount() {
            document.getElementById('reconnect-count').textContent = reconnectCount;
        }

        // æ—¥å¿—è¾“å‡º
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-message">${message}</span>`;
            logOutput.appendChild(entry);
            logOutput.scrollTop = logOutput.scrollHeight;

            console.log(`[${time}] ${message}`);
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initProgressBar();
            log('é¡µé¢åŠ è½½å®Œæˆ');
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (progressBar) {
                progressBar.destroy();
            }
        });
    </script>
</body>
</html>

# å†…å®¹ç”Ÿæˆå™¨é€Ÿç‡é™åˆ¶æ–‡æ¡£

## æ¦‚è¿°

`RedBookContentGenerator` é›†æˆäº†é€Ÿç‡é™åˆ¶åŠŸèƒ½ï¼Œç”¨äºæ§åˆ¶ OpenAI API çš„è°ƒç”¨é¢‘ç‡ï¼Œé¿å…è¶…è¿‡ API é…é¢é™åˆ¶ã€‚é€Ÿç‡é™åˆ¶åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼Œæ”¯æŒ RPMï¼ˆæ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼‰å’Œ TPMï¼ˆæ¯åˆ†é’Ÿä»¤ç‰Œæ•°ï¼‰ä¸¤ç§é™åˆ¶ã€‚

## åŠŸèƒ½ç‰¹æ€§

- âœ… **RPM é™åˆ¶**ï¼šæ§åˆ¶æ¯åˆ†é’Ÿçš„ API è¯·æ±‚æ¬¡æ•°
- âœ… **TPM é™åˆ¶**ï¼šæ§åˆ¶æ¯åˆ†é’Ÿçš„ token ä½¿ç”¨é‡
- âœ… **è‡ªåŠ¨ç­‰å¾…**ï¼šè¶…é™æ—¶è‡ªåŠ¨ç­‰å¾…ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
- âœ… **ä»¤ç‰Œæ¢å¤**ï¼šä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡è‡ªåŠ¨æ¢å¤
- âœ… **é…ç½®çµæ´»**ï¼šæ”¯æŒé…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
- âœ… **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†çš„é€Ÿç‡é™åˆ¶æ—¥å¿—
- âœ… **ç»Ÿè®¡ä¿¡æ¯**ï¼šå®æ—¶æŸ¥çœ‹ä»¤ç‰Œä½¿ç”¨æƒ…å†µ

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶

åœ¨ `config/config.json` ä¸­é…ç½®é€Ÿç‡é™åˆ¶ï¼š

```json
{
  "rate_limit": {
    "openai": {
      "enable_rate_limit": true,
      "requests_per_minute": 60,
      "tokens_per_minute": 90000
    }
  }
}
```

**é…ç½®é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `enable_rate_limit` | boolean | `true` | æ˜¯å¦å¯ç”¨é€Ÿç‡é™åˆ¶ |
| `requests_per_minute` | integer | `60` | æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼ˆRPMï¼‰ |
| `tokens_per_minute` | integer | `90000` | æ¯åˆ†é’Ÿæœ€å¤§ token æ•°ï¼ˆTPMï¼‰ |

### ç¯å¢ƒå˜é‡

ä¹Ÿå¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®ï¼š

```bash
# å¯ç”¨/ç¦ç”¨é€Ÿç‡é™åˆ¶
export RATE_LIMIT_OPENAI_ENABLE_RATE_LIMIT=true

# è®¾ç½® RPM
export RATE_LIMIT_OPENAI_RPM=120

# è®¾ç½® TPM
export RATE_LIMIT_OPENAI_TPM=180000
```

**ä¼˜å…ˆçº§**ï¼šç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```python
from src.content_generator import RedBookContentGenerator
from src.core.config_manager import ConfigManager

# åˆ›å»ºé…ç½®ç®¡ç†å™¨
config_manager = ConfigManager("config/config.json")

# åˆ›å»ºå†…å®¹ç”Ÿæˆå™¨ï¼ˆè‡ªåŠ¨å¯ç”¨é€Ÿç‡é™åˆ¶ï¼‰
generator = RedBookContentGenerator(config_manager=config_manager)

# æ­£å¸¸ä½¿ç”¨ï¼Œé€Ÿç‡é™åˆ¶ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
content = generator.generate_content("è€åŒ—äº¬èƒ¡åŒçš„è®°å¿†")
```

### æ£€æŸ¥é€Ÿç‡é™åˆ¶çŠ¶æ€

```python
# è·å–é€Ÿç‡é™åˆ¶ç»Ÿè®¡ä¿¡æ¯
stats = generator.get_rate_limit_stats()

if stats:
    print(f"é€Ÿç‡é™åˆ¶å·²å¯ç”¨")
    print(f"RPM å¯ç”¨ä»¤ç‰Œ: {stats['rpm']['available_tokens']:.2f}")
    print(f"TPM å¯ç”¨ä»¤ç‰Œ: {stats['tpm']['available_tokens']:.2f}")
else:
    print("é€Ÿç‡é™åˆ¶æœªå¯ç”¨")
```

### ç¦ç”¨é€Ÿç‡é™åˆ¶

å¦‚æœéœ€è¦ç¦ç”¨é€Ÿç‡é™åˆ¶ï¼ˆä¸æ¨èï¼‰ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```json
{
  "rate_limit": {
    "openai": {
      "enable_rate_limit": false
    }
  }
}
```

æˆ–é€šè¿‡ç¯å¢ƒå˜é‡ï¼š

```bash
export RATE_LIMIT_OPENAI_ENABLE_RATE_LIMIT=false
```

## å·¥ä½œåŸç†

### ä»¤ç‰Œæ¡¶ç®—æ³•

é€Ÿç‡é™åˆ¶åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°ï¼š

1. **ä»¤ç‰Œç”Ÿæˆ**ï¼šä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡ç”Ÿæˆå¹¶æ”¾å…¥æ¡¶ä¸­
2. **æ¡¶å®¹é‡é™åˆ¶**ï¼šæ¡¶æœ‰æœ€å¤§å®¹é‡ï¼Œè¶…è¿‡å®¹é‡çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒ
3. **è¯·æ±‚æ¶ˆè€—ä»¤ç‰Œ**ï¼šæ¯æ¬¡ API è¯·æ±‚éœ€è¦æ¶ˆè€—ä»¤ç‰Œ
4. **è‡ªåŠ¨ç­‰å¾…**ï¼šå¦‚æœä»¤ç‰Œä¸è¶³ï¼Œè¯·æ±‚ä¼šè‡ªåŠ¨ç­‰å¾…ç›´åˆ°è·å–åˆ°ä»¤ç‰Œ

### RPM é™åˆ¶

- **æ¯æ¬¡è¯·æ±‚æ¶ˆè€— 1 ä¸ª RPM ä»¤ç‰Œ**
- ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ = `requests_per_minute / 60` ä»¤ç‰Œ/ç§’
- æ¡¶å®¹é‡ = `requests_per_minute` ä»¤ç‰Œ

ç¤ºä¾‹ï¼š`requests_per_minute=60` è¡¨ç¤ºæ¯ç§’ç”Ÿæˆ 1 ä¸ªä»¤ç‰Œï¼Œæ¡¶å®¹é‡ä¸º 60 ä¸ªä»¤ç‰Œã€‚

### TPM é™åˆ¶

- **æ¯æ¬¡è¯·æ±‚æ¶ˆè€—ä¼°ç®—çš„ token æ•°é‡**
- ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ = `tokens_per_minute / 60` ä»¤ç‰Œ/ç§’
- æ¡¶å®¹é‡ = `tokens_per_minute` ä»¤ç‰Œ

ç¤ºä¾‹ï¼š`tokens_per_minute=90000` è¡¨ç¤ºæ¯ç§’ç”Ÿæˆ 1500 ä¸ªä»¤ç‰Œï¼Œæ¡¶å®¹é‡ä¸º 90000 ä¸ªä»¤ç‰Œã€‚

**Token ä¼°ç®—**ï¼š
- ç®€å•ä¼°ç®—ï¼šæ¯ä¸ªå­—ç¬¦çº¦ 0.5 ä¸ª tokenï¼ˆä¸­æ–‡çº¦ 1.5-2 ä¸ªå­—ç¬¦/tokenï¼‰
- æœ€å°é¢„ç•™ï¼š100 tokens

### ç­‰å¾…æœºåˆ¶

å½“ä»¤ç‰Œä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç­‰å¾…ï¼š

1. **è®¡ç®—ç­‰å¾…æ—¶é—´**ï¼šæ ¹æ®éœ€è¦çš„ä»¤ç‰Œæ•°å’Œç”Ÿæˆé€Ÿç‡è®¡ç®—
2. **è‡ªåŠ¨ç­‰å¾…**ï¼šé˜»å¡å½“å‰è¯·æ±‚ç›´åˆ°è·å–åˆ°ä»¤ç‰Œ
3. **è¶…æ—¶ä¿æŠ¤**ï¼šé»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 60 ç§’
4. **é™çº§ç­–ç•¥**ï¼šTPM è¶…æ—¶æ—¶ä½¿ç”¨é™çº§ç­–ç•¥ï¼ˆè·å–éƒ¨åˆ†ä»¤ç‰Œï¼‰

## æ—¥å¿—è®°å½•

### æ—¥å¿—çº§åˆ«

è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º `DEBUG` å¯ä»¥æŸ¥çœ‹è¯¦ç»†çš„é€Ÿç‡é™åˆ¶æ—¥å¿—ï¼š

```json
{
  "logging": {
    "level": "DEBUG"
  }
}
```

### æ—¥å¿—ç¤ºä¾‹

```
âœ… [2026-02-13 10:30:00] [INFO] content_generator: é€Ÿç‡é™åˆ¶å·²å¯ç”¨ | requests_per_minute=60, tokens_per_minute=90000
ğŸ” [2026-02-13 10:30:01] [DEBUG] content_generator: æ­£åœ¨è·å– RPM ä»¤ç‰Œ | available_tokens=60.0
âœ… [2026-02-13 10:30:01] [DEBUG] content_generator: å·²è·å– RPM ä»¤ç‰Œ | remaining_tokens=59.0
ğŸ” [2026-02-13 10:30:01] [DEBUG] content_generator: æ­£åœ¨è·å– TPM ä»¤ç‰Œ | estimated_tokens=1000, available_tokens=90000.0
âœ… [2026-02-13 10:30:01] [DEBUG] content_generator: å·²è·å– TPM ä»¤ç‰Œ | remaining_tokens=89000.0
ğŸ” [2026-02-13 10:30:01] [DEBUG] content_generator: æ­£åœ¨è°ƒç”¨ OpenAI API | model=qwen-plus, temperature=0.8
âœ… [2026-02-13 10:30:02] [DEBUG] content_generator: OpenAI API è°ƒç”¨æˆåŠŸ | model=qwen-plus
```

## æ€§èƒ½å½±å“

### æ­£å¸¸æƒ…å†µ

- **æ— å½±å“**ï¼šä»¤ç‰Œå……è¶³æ—¶ï¼Œé€Ÿç‡é™åˆ¶ä¸ä¼šå¢åŠ å»¶è¿Ÿ
- **è‡ªåŠ¨æ¢å¤**ï¼šä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡æ¢å¤ï¼Œé•¿æœŸå¹³å‡é€Ÿç‡å—æ§

### è¶…é™æƒ…å†µ

- **è‡ªåŠ¨ç­‰å¾…**ï¼šä»¤ç‰Œä¸è¶³æ—¶è‡ªåŠ¨ç­‰å¾…ï¼Œé¿å… API è°ƒç”¨å¤±è´¥
- **ç­‰å¾…æ—¶é—´**ï¼šå–å†³äºä»¤ç‰Œæ¢å¤é€Ÿç‡å’Œéœ€è¦çš„ä»¤ç‰Œæ•°
- **è¶…æ—¶ä¿æŠ¤**ï¼šé»˜è®¤ 60 ç§’è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **åˆç†é…ç½® RPM/TPM**ï¼šæ ¹æ® API é…é¢è®¾ç½®åˆç†çš„é™åˆ¶
2. **å¯ç”¨ç¼“å­˜**ï¼šé¿å…é‡å¤ç”Ÿæˆç›¸åŒå†…å®¹
3. **æ‰¹é‡å¤„ç†**ï¼šåˆå¹¶å¤šä¸ªè¯·æ±‚ï¼Œå‡å°‘ API è°ƒç”¨æ¬¡æ•°
4. **ç›‘æ§ä»¤ç‰Œä½¿ç”¨**ï¼šå®šæœŸæ£€æŸ¥ä»¤ç‰Œä½¿ç”¨æƒ…å†µï¼Œè°ƒæ•´é…ç½®

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ç¡®å®šåˆé€‚çš„ RPM/TPM å€¼ï¼Ÿ

**A**: æ ¹æ®ä½ çš„ API é…é¢è®¾ç½®ï¼š

- **é˜¿é‡Œäº‘é€šä¹‰åƒé—®**ï¼š
  - å…è´¹ç‰ˆï¼šçº¦ 60 RPMï¼Œ90000 TPM
  - ä»˜è´¹ç‰ˆï¼šæ ¹æ®è´­ä¹°çš„é…é¢è®¾ç½®
- **OpenAI**ï¼š
  - GPT-3.5ï¼šçº¦ 3500 RPMï¼Œ90000 TPM
  - GPT-4ï¼šçº¦ 500 RPMï¼Œ10000 TPM

å»ºè®®è®¾ç½®ä¸ºé…é¢çš„ 80-90%ï¼Œç•™æœ‰ä½™é‡ã€‚

### Q2: é€Ÿç‡é™åˆ¶ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ

**A**: æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šï¼š

- ä»¤ç‰Œå……è¶³æ—¶ï¼Œé€Ÿç‡é™åˆ¶ä¸ä¼šå¢åŠ å»¶è¿Ÿ
- åªæœ‰åœ¨è¶…é™æ—¶æ‰ä¼šç­‰å¾…
- é€šè¿‡åˆç†é…ç½®å’Œç¼“å­˜å¯ä»¥é¿å…è¶…é™

### Q3: å¦‚ä½•å¤„ç†è¶…æ—¶é”™è¯¯ï¼Ÿ

**A**: è¶…æ—¶é”™è¯¯é€šå¸¸è¡¨ç¤º RPM é™åˆ¶è¿‡ä½ï¼š

1. æ£€æŸ¥é…ç½®çš„ RPM å€¼æ˜¯å¦åˆç†
2. å¢åŠ  RPM é™åˆ¶ï¼ˆå¦‚æœé…é¢å…è®¸ï¼‰
3. å¯ç”¨ç¼“å­˜å‡å°‘ API è°ƒç”¨
4. ä½¿ç”¨æ‰¹é‡å¤„ç†å‡å°‘è¯·æ±‚é¢‘ç‡

### Q4: å¯ä»¥ä¸ºä¸åŒçš„ API è®¾ç½®ä¸åŒçš„é™åˆ¶å—ï¼Ÿ

**A**: å¯ä»¥ï¼Œä½¿ç”¨ `MultiRateLimiter`ï¼š

```python
from src.core.rate_limiter import MultiRateLimiter

# åˆ›å»ºå¤šé€Ÿç‡é™åˆ¶å™¨
limiter = MultiRateLimiter()

# ä¸ºä¸åŒçš„ API æ·»åŠ é™åˆ¶å™¨
limiter.add_limiter("openai", rate=60/60, capacity=60)
limiter.add_limiter("image", rate=10/60, capacity=10)

# ä½¿ç”¨
limiter.wait_for_token("openai", tokens=1)
limiter.wait_for_token("image", tokens=1)
```

### Q5: å¦‚ä½•ç›‘æ§é€Ÿç‡é™åˆ¶çŠ¶æ€ï¼Ÿ

**A**: ä½¿ç”¨ `get_rate_limit_stats()` æ–¹æ³•ï¼š

```python
stats = generator.get_rate_limit_stats()

if stats:
    rpm_usage = (stats['rpm']['capacity'] - stats['rpm']['available_tokens']) / stats['rpm']['capacity']
    tpm_usage = (stats['tpm']['capacity'] - stats['tpm']['available_tokens']) / stats['tpm']['capacity']
    
    print(f"RPM ä½¿ç”¨ç‡: {rpm_usage:.1%}")
    print(f"TPM ä½¿ç”¨ç‡: {tpm_usage:.1%}")
```

## æœ€ä½³å®è·µ

### 1. åˆç†é…ç½®é™åˆ¶

```json
{
  "rate_limit": {
    "openai": {
      "enable_rate_limit": true,
      "requests_per_minute": 60,    // æ ¹æ® API é…é¢è®¾ç½®
      "tokens_per_minute": 90000    // æ ¹æ® API é…é¢è®¾ç½®
    }
  }
}
```

### 2. å¯ç”¨ç¼“å­˜

```json
{
  "cache": {
    "enabled": true,
    "ttl": 3600,
    "max_size": 1000
  }
}
```

### 3. ç›‘æ§æ—¥å¿—

```json
{
  "logging": {
    "level": "INFO",    // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ INFO
    "format": "json"    // ä¾¿äºæ—¥å¿—åˆ†æ
  }
}
```

### 4. å®šæœŸæ£€æŸ¥ç»Ÿè®¡

```python
# å®šæœŸæ£€æŸ¥é€Ÿç‡é™åˆ¶çŠ¶æ€
stats = generator.get_rate_limit_stats()
if stats:
    rpm_available = stats['rpm']['available_tokens']
    if rpm_available < 10:
        print("âš ï¸  RPM ä»¤ç‰Œå³å°†è€—å°½ï¼Œè¯·ç­‰å¾…æ¢å¤")
```

### 5. é”™è¯¯å¤„ç†

```python
try:
    content = generator.generate_content(input_text)
except TimeoutError as e:
    print(f"âŒ é€Ÿç‡é™åˆ¶è¶…æ—¶: {e}")
    print("å»ºè®®ï¼šå¢åŠ  RPM é™åˆ¶æˆ–å¯ç”¨ç¼“å­˜")
except Exception as e:
    print(f"âŒ ç”Ÿæˆå¤±è´¥: {e}")
```

## ç›¸å…³æ–‡æ¡£

- [é€Ÿç‡é™åˆ¶å™¨æ–‡æ¡£](RATE_LIMITER.md)
- [é€Ÿç‡é™åˆ¶ç­–ç•¥æ–‡æ¡£](RATE_LIMITER_STRATEGIES.md)
- [é…ç½®ç®¡ç†æ–‡æ¡£](CONFIG.md)
- [ç¼“å­˜ç®¡ç†æ–‡æ¡£](CACHE_MANAGER.md)

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-02-13)

- âœ… åˆå§‹ç‰ˆæœ¬
- âœ… æ”¯æŒ RPM å’Œ TPM é™åˆ¶
- âœ… è‡ªåŠ¨ç­‰å¾…å’Œè¶…æ—¶ä¿æŠ¤
- âœ… é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡æ”¯æŒ
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢

# 实施计划：火山引擎即梦 AI 图片生成集成

## 概述

本实施计划将火山引擎即梦 AI 图片生成服务集成到 RedBookContentGen 项目中。实施采用渐进式方法，先实现核心功能，再添加测试和优化。每个任务都引用了相应的需求，确保可追溯性。

## 任务

- [x] 1. 创建抽象基类和项目结构
  - 创建 `src/image_providers/` 目录
  - 创建 `src/image_providers/__init__.py`
  - 创建 `src/image_providers/base.py` 定义 `BaseImageProvider` 抽象基类
  - 定义统一的图片生成接口（`generate()`, `get_provider_name()`）
  - _需求: 9.2, 9.3_

- [ ] 2. 实现 AWS Signature V4 签名算法
  - [x] 2.1 创建签名工具类
    - 创建 `src/volcengine/signature.py`
    - 实现 `VolcengineSignatureV4` 类
    - 实现 Base64 密钥解码功能 `_decode_secret_key()`
    - _需求: 2.1, 2.3_
  
  - [x] 2.2 实现签名计算方法
    - 实现 `_get_canonical_request()` 方法（构建规范请求）
    - 实现 `_get_string_to_sign()` 方法（构建待签名字符串）
    - 实现 `_get_signature()` 方法（计算 HMAC-SHA256 签名）
    - 实现 `sign()` 主方法（生成 Authorization 头）
    - _需求: 2.1, 2.2, 2.4_
  
  - [x] 2.3 编写签名算法单元测试
    - 使用 AWS 官方测试向量验证签名正确性
    - 测试 Base64 密钥解码
    - 测试请求头完整性
    - 测试错误处理
    - _需求: 2.1, 2.3, 2.4, 2.5_

- [ ] 3. 实现火山引擎图片生成服务提供商
  - [x] 3.1 创建 VolcengineImageProvider 类
    - 创建 `src/image_providers/volcengine_provider.py`
    - 实现 `VolcengineImageProvider` 类继承 `BaseImageProvider`
    - 实现 `__init__()` 方法（初始化配置、日志、速率限制、缓存）
    - 实现 `get_provider_name()` 方法返回 "volcengine"
    - _需求: 3.1, 4.1_
  
  - [x] 3.2 实现图片生成核心流程
    - 实现 `generate()` 方法（主入口）
    - 实现缓存检查逻辑
    - 实现速率限制检查逻辑
    - 实现 `_create_task()` 方法（创建图片生成任务）
    - 实现 `_poll_status()` 方法（轮询任务状态）
    - 实现图片下载和保存逻辑
    - 实现缓存结果逻辑
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 6.4, 6.5_
  
  - [x] 3.3 实现错误处理和重试机制
    - 实现 `_handle_api_error()` 方法（错误分类和处理）
    - 实现可重试错误的重试逻辑（最多 3 次）
    - 实现指数退避策略（1s, 2s, 4s）
    - 实现不可重试错误的立即返回
    - 实现详细的错误日志记录
    - _需求: 3.6, 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [x] 3.4 编写 VolcengineImageProvider 属性测试
    - **属性 10: 尺寸参数传递** - 验证尺寸参数正确传递到 API
    - **属性 11: 轮询终止条件** - 验证轮询在正确条件下终止
    - **属性 12: 图片保存完整性** - 验证图片正确保存
    - **属性 13: API 失败重试** - 验证失败时正确重试
    - **属性 17: 可重试错误重试次数** - 验证重试最多 3 次
    - **属性 18: 不可重试错误立即返回** - 验证不可重试错误立即返回
    - **属性 19: 重试耗尽错误返回** - 验证重试耗尽后返回最后错误
    - **属性 20: 指数退避策略** - 验证重试间隔符合指数退避
    - _需求: 3.3, 3.4, 3.5, 3.6, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 4. 重构现有阿里云代码为 AliyunImageProvider
  - [x] 4.1 创建 AliyunImageProvider 类
    - 创建 `src/image_providers/aliyun_provider.py`
    - 实现 `AliyunImageProvider` 类继承 `BaseImageProvider`
    - 将 `ImageGenerator` 中的阿里云相关代码迁移到此类
    - 实现 `generate()` 方法
    - 实现 `get_provider_name()` 方法返回 "aliyun"
    - _需求: 9.2, 9.3_
  
  - [x] 4.2 编写 AliyunImageProvider 单元测试
    - 测试现有功能是否正常工作
    - 测试与 ImageGenerator 的集成
    - _需求: 9.2, 9.3_

- [ ] 5. 更新配置管理
  - [x] 5.1 添加火山引擎配置项
    - 在 `ConfigManager.DEFAULT_CONFIG` 中添加火山引擎默认配置
    - 在 `ConfigManager.ENV_VAR_MAPPING` 中添加环境变量映射
    - 添加 `image_api_provider` 配置项（默认值 "aliyun"）
    - _需求: 1.1, 1.2, 1.3_
  
  - [x] 5.2 更新配置示例文件
    - 在 `config/config.example.json` 中添加火山引擎配置示例
    - 使用环境变量占位符（如 `${VOLCENGINE_ACCESS_KEY_ID}`）
    - 添加详细的注释说明
    - _需求: 10.4, 11.1_
  
  - [x] 5.3 编写配置管理属性测试
    - **属性 1: 配置加载完整性** - 验证所有配置项正确加载
    - **属性 2: 环境变量覆盖** - 验证环境变量正确覆盖配置文件
    - **属性 3: 环境变量引用解析** - 验证 ${ENV_VAR} 语法正确解析
    - **属性 4: 配置默认值和错误处理** - 验证默认值和错误处理
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 6. 修改 ImageGenerator 集成新架构
  - [x] 6.1 添加工厂方法
    - 在 `ImageGenerator` 中添加 `_get_image_provider()` 工厂方法
    - 根据 `image_api_provider` 配置返回对应的提供商实例
    - 实现默认值和回退逻辑
    - _需求: 4.1, 4.4, 9.1, 9.4_
  
  - [x] 6.2 修改图片生成方法
    - 修改 `generate_single_image()` 使用提供商接口
    - 修改 `generate_image_async()` 使用提供商接口
    - 保持方法签名不变（向后兼容）
    - _需求: 3.1, 9.2, 9.3_
  
  - [x] 6.3 编写集成测试
    - 测试工厂方法正确选择提供商
    - 测试阿里云和火山引擎的切换
    - 测试向后兼容性
    - **属性 9: 提供商选择正确性** - 验证根据配置选择正确提供商
    - **属性 14: 默认提供商回退** - 验证默认回退到阿里云
    - **属性 26: API 接口兼容性** - 验证接口保持不变
    - **属性 27: 配置结构兼容性** - 验证配置兼容性
    - _需求: 3.1, 4.1, 4.4, 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 7. 实现日志记录和安全功能
  - [x] 7.1 实现日志记录
    - 在所有关键操作点添加日志记录
    - 记录 API 请求参数（不含敏感信息）
    - 记录 API 响应状态码和关键信息
    - 记录错误堆栈信息
    - _需求: 7.1, 7.2, 7.3, 7.4_
  
  - [x] 7.2 实现密钥脱敏
    - 实现 `_mask_sensitive_data()` 工具函数
    - 在日志记录前对 API 密钥进行脱敏（只显示前 4 位和后 4 位）
    - 确保配置文件在 .gitignore 中
    - _需求: 10.1, 10.2, 10.5_
  
  - [x] 7.3 编写日志和安全属性测试
    - **属性 23: 日志系统集成** - 验证使用 Logger 模块
    - **属性 24: 请求日志脱敏** - 验证密钥脱敏处理
    - **属性 25: 响应日志记录** - 验证响应日志记录
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5, 10.1, 10.2_

- [x] 8. 添加命令行接口支持
  - [x] 8.1 更新 run.py 命令行参数
    - 添加 `--image-provider` 或 `--provider` 参数
    - 支持 "aliyun" 和 "volcengine" 选项
    - 实现命令行参数优先级（高于配置文件）
    - 更新帮助信息
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [x] 8.2 编写命令行接口单元测试
    - 测试参数解析
    - 测试优先级逻辑
    - 测试帮助信息
    - **属性 15: 命令行参数优先级** - 验证命令行参数优先
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9. 实现速率限制和缓存
  - [x] 9.1 配置速率限制
    - 在配置中添加火山引擎速率限制配置
    - 在 `VolcengineImageProvider` 中集成现有的 `RateLimiter`
    - 实现速率限制检查和等待逻辑
    - _需求: 6.1, 6.2, 6.3_
  
  - [x] 9.2 配置缓存
    - 在 `VolcengineImageProvider` 中集成现有的 `CacheManager`
    - 实现缓存键生成（基于提示词和参数的哈希）
    - 实现缓存检查和存储逻辑
    - _需求: 6.4, 6.5_
  
  - [x] 9.3 编写速率限制和缓存属性测试
    - **属性 21: 速率限制检查** - 验证速率限制正确工作
    - **属性 22: 缓存幂等性** - 验证缓存幂等性
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 10. 检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 检查测试覆盖率（目标 80% 以上）
  - 修复任何失败的测试
  - 如有问题，询问用户

- [x] 11. 更新文档
  - [x] 11.1 更新 README.md
    - 添加火山引擎集成说明
    - 添加配置示例
    - 添加命令行使用示例
    - 说明如何获取火山引擎 API 密钥
    - 说明阿里云和火山引擎的差异和选择建议
    - _需求: 11.2, 11.3, 11.4, 11.5_
  
  - [x] 11.2 创建或更新 docs/VOLCENGINE.md
    - 详细说明火山引擎集成
    - 提供完整的配置示例
    - 提供 API 密钥获取步骤
    - 提供故障排除指南
    - _需求: 11.2, 11.3_
  
  - [x] 11.3 更新 AGENTS.md
    - 添加火山引擎相关的项目结构说明
    - 更新构建和运行命令
    - 添加测试命令
    - _需求: 11.4_

- [x] 12. 端到端测试和验证
  - [x] 12.1 手动测试
    - 使用真实的火山引擎 API 密钥测试图片生成
    - 测试阿里云和火山引擎的切换
    - 测试命令行参数
    - 测试错误处理和重试
    - 测试缓存功能
    - 验证日志输出
    - _需求: 所有需求_
  
  - [x] 12.2 性能测试
    - 测试速率限制是否正常工作
    - 测试缓存是否提高性能
    - 测试并发请求处理
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 13. 最终检查点 - 确保所有功能正常
  - 确保所有测试通过
  - 确保文档完整
  - 确保代码符合项目风格指南
  - 如有问题，询问用户

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求，确保可追溯性
- 检查点任务确保渐进式验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 所有代码应遵循 AGENTS.md 中定义的代码风格
- 所有注释和文档使用中文
- 确保向后兼容性，不破坏现有功能

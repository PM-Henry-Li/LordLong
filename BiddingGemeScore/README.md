# 需求优先级打分与资源分配系统

根据《FY25系统功能使用考核-节奏拉齐》规则进行需求优先级计算和资源分配。

## 功能特点

- ✅ **自动识别X类需求**：系统故障/阻断性问题直接列为"必须执行"，不参与打分
- ✅ **优先级打分**：根据需求分类、季度计划、启动状态计算得分 S = A × B × C
- ✅ **资源配额分配**：按业务线分配资源，支持回流机制
- ✅ **轻学需求保护**：轻学需求保证入选，月度20分封顶，季度60分封顶
- ✅ **智能排期**：自动标记入选和待办需求
- ✅ **Markdown报告**：生成详细的排期决策报告

## 安装依赖

```bash
# 无需额外依赖，使用Python标准库
python3 --version  # 需要 Python 3.6+
```

## 使用方法

### 1. 准备数据文件

支持两种格式：**CSV** 或 **JSON**

#### CSV格式示例 - 新模板（推荐）

```csv
所属业务团队,关联目标及方向,需求标题,核心交付功能说明,当前数据及落地指标,收益,业务需求优先级,启动状态,时间维度
考研,无,需求A-考核落地项,实现核心功能A,当前指标50%,预期提升20%,考核落地项,开发中,季度
轻学,关联1个重点项目,需求H-轻学月度需求,实现轻学功能H,当前指标30%,预期提升15%,其他需求,开发中,月度
```

**新模板字段说明**：
- `所属业务团队`: 考研/四六级/专升本/轻学（必填）
- `关联目标及方向`: 关联重点项目说明，可包含数字（可选）
- `需求标题`: 需求的名称（必填）
- `核心交付功能说明`: 功能描述（可选）
- `当前数据及落地指标`: 当前指标数据（可选）
- `收益`: 预期收益（可选）
- `业务需求优先级`: 考核落地项/重点项目/其他需求（必填）
- `启动状态`: 开发中/尚未启动（必填）
- `时间维度`: 月度/季度（轻学需求必填）

#### CSV格式示例 - 旧模板（向后兼容）

```csv
需求名称,业务线,需求分类,季度计划,启动状态,是否故障,关联重点项目数,时间维度
需求A-考核落地项,考研,考核落地项,本季度,开发中,否,0,季度
```

**旧模板字段说明**：
- `需求名称`: 需求的名称（对应新模板的"需求标题"）
- `业务线`: 考研/四六级/专升本/轻学（对应新模板的"所属业务团队"）
- `需求分类`: 考核落地项/重点项目/其他需求（对应新模板的"业务需求优先级"）
- `季度计划`: 本季度/下季度/未进入（新模板中默认"未进入"）
- `启动状态`: 开发中/尚未启动
- `是否故障`: 是/否（X类需求标记，新模板中默认"否"）
- `关联重点项目数`: 关联的重点项目数量（对应新模板的"关联目标及方向"）
- `时间维度`: 月度/季度（轻学需求必填）

> 📝 **注意**: 系统同时支持新旧模板，可以混用字段名。详细说明请查看 `字段模板说明.md`

#### JSON格式示例 (`requirements.json`)

```json
{
  "total_score": 1000,
  "requirements": [
    {
      "name": "需求A-考核落地项",
      "business_line": "考研",
      "category": "考核落地项",
      "quarter_plan": "本季度",
      "status": "开发中",
      "is_fault": false,
      "related_projects": 0
    }
  ]
}
```

### 2. 运行脚本

```bash
# 使用CSV文件（生成Markdown报告）
python3 requirement_scorer.py -i requirements_template_new.csv -t 150 -o output/report.md

# 使用CSV文件（生成HTML网页报告）
python3 requirement_scorer.py -i requirements_template_new.csv -t 150 -o output/report.html --html

# 使用JSON文件
python3 requirement_scorer.py -i requirements.json -t 1000 -o output/report.md

# 指定文件格式（如果自动检测失败）
python3 requirement_scorer.py -i requirements.csv -t 1000 -f csv -o output/report.md
```

**参数说明**：
- `-i, --input`: 输入文件路径（必需）
- `-t, --total-score`: 可用总分池（必需）
- `-o, --output`: 输出文件路径（默认: output/report.md）
- `-f, --format`: 输入文件格式 csv/json/auto（默认: auto自动检测）
- `--html`: 生成HTML格式报告（网页展示），美观易读
- `--html`: 生成HTML格式报告（网页展示），美观易读

### 3. 查看结果

报告支持两种格式：

**Markdown格式**（默认）：
- 适合在代码编辑器或Markdown阅读器中查看
- 文件扩展名：`.md`

**HTML格式**（网页展示）：
- 美观的网页界面，包含图表和进度条
- 适合在浏览器中查看和分享
- 使用 `--html` 参数生成
- 文件扩展名：`.html`

报告内容包含：

1. **统计概览**：总需求数、入选数、待办数、X类需求数（HTML格式）
2. **配额分配概览**：各业务线的初始比例、回流情况、最终配额
3. **X类紧急通道**：系统故障/阻断性问题列表
4. **最终排期决策表**：所有需求的详细打分和决策结果
5. **分析总结**：资源使用情况（含进度条）和待办需求建议

## 打分规则

### 优先级得分公式

**第一步：计算原始得分（作为比例）**

$$S_{原始} = A \times B \times C$$

**A (需求分类)**:
- **A类**：【考核类】且在落地阶段 = **10分**
- **B类**：【重点项目】= **3分** + 关联重点项目数
- **C类**：【数据需求】= **3分**
- **D类**：【非考核类】+ 【考核类】落地结束 = **1分**
- **E类**：【季度重点】= **6分**
- **X类**：系统故障或学员大面积无法使用 = **不参与打分**（直接列为"必须执行"）

**B (季度计划)**:
- 进入本季度计划 = **3分**
- 进入下季度计划 = **2分**
- 未进入计划 = **1分**

**C (启动状态)**:
- 开发中 = **5分**
- 尚未启动 = **1分**

**第二步：按比例分配总分池**

$$S_{分配} = \frac{S_{原始}}{S_{总原始}} \times T_{总分池}$$

其中：
- $S_{原始}$ = 单个需求的原始得分（A × B × C）
- $S_{总原始}$ = 所有需求的原始得分总和
- $T_{总分池}$ = 传入的可用总分池参数（如150分）

**说明**：
- 原始得分作为比例，用于反映需求的相对优先级
- 分配得分 = 原始得分按比例分配后的分数，用于配额判断
- 所有需求的分配得分总和 = 可用总分池

### 资源配额分配

**初始比例**:
- 考研: 60%
- 四六级: 20%
- 专升本: 20%

**回流机制**:
- 若【四六级】无需求，其20%配额全额转给【考研】
- 若【专升本】无需求，其20%配额全额转给【考研】
- 若两者皆无，【考研】独占100%配额

**轻学配额规则**:
- 轻学是考研的一部分，轻学需求保证能够进入排期
- 轻学配额从考研配额中预留：
  - **月度轻学**: 20分封顶
  - **季度轻学**: 60分封顶
- 轻学需求优先分配，不受考研配额限制影响

### 选取逻辑

1. **计算原始得分**：每个需求计算 $S_{原始} = A \times B \times C$（作为比例）
2. **按比例分配**：将所有原始得分按比例分配可用总分池，得到 $S_{分配}$
3. **配额判断**：
   - 在各业务线内部，按分配得分 $S_{分配}$ 从高到低排序
   - 依次累加 $S_{分配}$，直到累计分数超过该业务线的**配额上限**
   - 配额内的需求标记为"✅ 入选"，配额外标记为"⏸️ 待办(Backlog)"

**示例**：
- 假设总原始得分 = 51分，可用总分池 = 150分
- 原始得分6.0的需求 → 分配得分 = (6/51) × 150 = 17.65分
- 原始得分3.0的需求 → 分配得分 = (3/51) × 150 = 8.82分
- 原始得分1.0的需求 → 分配得分 = (1/51) × 150 = 2.94分

## 示例

### 运行示例数据

```bash
# 使用CSV示例文件
python3 requirement_scorer.py -i requirements_example.csv -t 1000 -o output/example_report.md

# 使用JSON示例文件
python3 requirement_scorer.py -i requirements_example.json -t 1000 -o output/example_report.md
```

### 输出示例

报告将包含类似以下内容：

```markdown
# 需求优先级打分与资源分配报告

## 1. 配额分配概览

| **业务线** | **初始比例** | **是否触发回流** | **最终可用配额 (分)** |
| ---------- | ------------ | ---------------- | --------------------- |
| 考研       | 60%          | 否               | 600.00                |
| 四六级     | 20%          | 否               | 200.00                |
| 专升本     | 20%          | 否               | 200.00                |

## 2. X类紧急通道 (不占分/优先处理)

- **需求D-故障修复** - 四六级业务线（系统故障/阻断性问题）

## 3. 最终排期决策表

| **优先级** | **业务线** | **需求名称** | **A.分类** | **B.计划** | **C.状态** | **原始得分** | **分配得分** | **决策结果** |
| ---------- | ---------- | ------------ | ---------- | ---------- | ---------- | ------------ | ------------ | --------------- |
| 1          | 考研       | 需求A-考核落地项 | 10         | 3          | 5          | 150          | **XX.XX**    | ✅ 入选          |
...
```

## 注意事项

1. **X类需求**：
   - 分类字段填写"X类"或包含"系统故障"、"大面积无法使用"
   - 或"是否故障"字段为"是"
   - X类需求不参与打分，直接列为"必须执行"
2. **需求分类枚举值**：
   - **A类**：【考核类】且在落地阶段 = 10分
   - **B类**：【重点项目】= 3分 + 关联重点项目数
   - **C类**：【数据需求】= 3分
   - **D类**：【非考核类】+ 【考核类】落地结束 = 1分
   - **E类**：【季度重点】= 6分
   - **X类**：系统故障或学员大面积无法使用 = 不参与打分
3. **轻学需求**：
   - 业务线填写"轻学"或业务线包含"轻学"字样即可自动识别
   - 必须填写`时间维度`字段（月度/季度）
   - 轻学需求保证入选，不受考研配额限制
   - 月度轻学总分不超过20分，季度轻学总分不超过60分
4. **数据格式**：确保CSV文件使用UTF-8编码，字段名与示例一致
5. **业务线名称**：必须使用"考研"、"四六级"、"专升本"、"轻学"（区分大小写）
6. **需求分类**：支持新分类（A类/B类/C类/D类/E类/X类）或旧分类（考核落地项/重点项目/其他需求），系统会自动识别

## 文件结构

```
BiddingGemeScore/
├── requirement_scorer.py      # 主脚本
├── requirements_example.csv   # CSV示例文件
├── requirements_example.json    # JSON示例文件
├── requirements_template_new.csv # CSV新模板示例文件
├── README.md                     # 使用说明
├── 字段模板说明.md               # 字段模板详细说明
├── 快速开始.md                   # 快速开始指南
└── output/                       # 输出目录（自动创建）
    └── report.md                 # 生成的报告
```

## 许可证

内部使用工具，仅供项目组使用。
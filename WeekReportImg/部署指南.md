# WeekReportImg 服务器部署指南

本指南将帮助您将 WeekReportImg 项目部署到个人服务器上，并配置为系统服务，确保服务稳定运行。

## 前置要求

- Linux 服务器（Ubuntu/Debian/CentOS 等）
- Python 3.7 或更高版本
- 服务器 root 或 sudo 权限
- 基本命令行操作知识

## 一、服务器环境准备

### 1.1 检查 Python 版本

```bash
python3 --version
# 或
python --version
```

确保版本 >= 3.7。如果没有安装 Python 3，请先安装：

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install python3 python3-pip -y
```

**CentOS/RHEL:**
```bash
sudo yum install python3 python3-pip -y
```

### 1.2 安装 pip（如果未安装）

```bash
python3 -m ensurepip --upgrade
```

## 二、项目部署

### 2.1 上传项目文件到服务器

您可以通过以下方式之一上传项目：

**方式一：使用 git（推荐）**
```bash
# 在服务器上执行
cd /opt  # 或其他您喜欢的目录
git clone <your-repo-url> WeekReportImg
cd WeekReportImg
```

**方式二：使用 scp 上传**
```bash
# 在本地执行
scp -r WeekReportImg/ user@your-server:/opt/WeekReportImg
```

**方式三：使用 rsync**
```bash
# 在本地执行
rsync -avz WeekReportImg/ user@your-server:/opt/WeekReportImg/
```

### 2.2 安装项目依赖

```bash
cd /opt/WeekReportImg  # 或您上传的目录
pip3 install -r requirements-web.txt
```

### 2.3 创建必要的目录

```bash
mkdir -p output
chmod 755 output
```

### 2.4 测试运行

先手动测试服务是否能正常启动：

```bash
cd /opt/WeekReportImg
python3 app.py
```

在浏览器访问 `http://your-server-ip:5555`，如果能看到页面，说明服务正常。按 `Ctrl+C` 停止服务。

## 三、配置系统服务（使用 systemd）

### 3.1 创建 systemd 服务文件

创建服务配置文件：

```bash
sudo nano /etc/systemd/system/weekreportimg.service
```

将以下内容写入文件（**请根据实际情况修改路径和用户**）：

```ini
[Unit]
Description=WeekReportImg Web Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/WeekReportImg
Environment="PATH=/usr/bin:/usr/local/bin"
ExecStart=/usr/bin/python3 /opt/WeekReportImg/app.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

**重要配置说明：**
- `User` 和 `Group`: 建议使用 `www-data`（Ubuntu/Debian）或 `nginx`（CentOS），也可以使用您的用户名
- `WorkingDirectory`: 项目所在目录
- `ExecStart`: Python3 和 app.py 的完整路径（使用 `which python3` 查看）

### 3.2 修改项目目录权限

```bash
# 如果使用 www-data 用户
sudo chown -R www-data:www-data /opt/WeekReportImg
sudo chmod -R 755 /opt/WeekReportImg

# 如果使用您的用户名（例如 ubuntu）
sudo chown -R ubuntu:ubuntu /opt/WeekReportImg
sudo chmod -R 755 /opt/WeekReportImg
```

### 3.3 修改 app.py 以适配生产环境

编辑 `app.py`，将最后一行改为：

```python
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5555, debug=False)  # 生产环境关闭 debug
```

### 3.4 启动并启用服务

```bash
# 重新加载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start weekreportimg

# 设置开机自启
sudo systemctl enable weekreportimg

# 查看服务状态
sudo systemctl status weekreportimg
```

### 3.5 查看日志

```bash
# 查看服务日志
sudo journalctl -u weekreportimg -f

# 查看最近 100 行日志
sudo journalctl -u weekreportimg -n 100
```

## 四、配置防火墙

### 4.1 Ubuntu/Debian (UFW)

```bash
sudo ufw allow 5555/tcp
sudo ufw reload
```

### 4.2 CentOS/RHEL (firewalld)

```bash
sudo firewall-cmd --permanent --add-port=5555/tcp
sudo firewall-cmd --reload
```

### 4.3 云服务器安全组

如果使用云服务器（阿里云、腾讯云、AWS 等），还需要在控制台配置安全组规则，开放 5555 端口。

## 五、配置 Nginx 反向代理（可选但推荐）

使用 Nginx 反向代理可以提供更好的性能和安全性。

### 5.1 安装 Nginx

**Ubuntu/Debian:**
```bash
sudo apt install nginx -y
```

**CentOS/RHEL:**
```bash
sudo yum install nginx -y
```

### 5.2 创建 Nginx 配置文件

```bash
sudo nano /etc/nginx/sites-available/weekreportimg
```

**Ubuntu/Debian** 使用上述路径，**CentOS/RHEL** 使用：
```bash
sudo nano /etc/nginx/conf.d/weekreportimg.conf
```

配置文件内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或 IP

    # 如果使用域名，可以配置 SSL
    # listen 443 ssl;
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    client_max_body_size 10M;

    location / {
        proxy_pass http://127.0.0.1:5555;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 静态文件缓存（可选）
    location /output/ {
        proxy_pass http://127.0.0.1:5555;
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5.3 启用配置

**Ubuntu/Debian:**
```bash
sudo ln -s /etc/nginx/sites-available/weekreportimg /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

**CentOS/RHEL:**
```bash
sudo nginx -t  # 测试配置
sudo systemctl restart nginx
```

### 5.4 配置防火墙（如果使用 Nginx）

```bash
# UFW
sudo ufw allow 'Nginx Full'
sudo ufw delete allow 5555/tcp  # 删除直接暴露的端口

# firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

## 六、配置 SSL 证书（可选，推荐）

使用 Let's Encrypt 免费 SSL 证书：

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx -y  # Ubuntu/Debian
sudo yum install certbot python3-certbot-nginx -y  # CentOS/RHEL

# 获取证书（需要先配置域名 DNS 解析）
sudo certbot --nginx -d your-domain.com

# 自动续期测试
sudo certbot renew --dry-run
```

## 七、常用操作命令

### 7.1 服务管理

```bash
# 启动服务
sudo systemctl start weekreportimg

# 停止服务
sudo systemctl stop weekreportimg

# 重启服务
sudo systemctl restart weekreportimg

# 查看状态
sudo systemctl status weekreportimg

# 查看日志
sudo journalctl -u weekreportimg -f
```

### 7.2 更新项目

```bash
cd /opt/WeekReportImg
# 如果使用 git
git pull

# 重启服务
sudo systemctl restart weekreportimg
```

## 八、故障排查

### 8.1 服务无法启动

1. 检查服务状态和日志：
```bash
sudo systemctl status weekreportimg
sudo journalctl -u weekreportimg -n 50
```

2. 检查 Python 和依赖：
```bash
python3 --version
pip3 list | grep Flask
```

3. 检查端口占用：
```bash
sudo netstat -tlnp | grep 5555
# 或
sudo lsof -i :5555
```

4. 检查文件权限：
```bash
ls -la /opt/WeekReportImg
```

### 8.2 无法访问服务

1. 检查防火墙：
```bash
sudo ufw status  # Ubuntu/Debian
sudo firewall-cmd --list-all  # CentOS/RHEL
```

2. 检查服务是否运行：
```bash
sudo systemctl status weekreportimg
```

3. 检查端口监听：
```bash
sudo netstat -tlnp | grep 5555
```

4. 检查 Nginx（如果使用）：
```bash
sudo nginx -t
sudo systemctl status nginx
```

### 8.3 权限问题

```bash
# 确保 output 目录可写
sudo chmod 755 /opt/WeekReportImg/output
sudo chown -R www-data:www-data /opt/WeekReportImg/output
```

## 九、安全建议

1. **不要使用 root 用户运行服务**：使用普通用户或 www-data
2. **关闭 debug 模式**：生产环境设置 `debug=False`
3. **使用防火墙**：只开放必要的端口
4. **配置 SSL**：使用 HTTPS 加密传输
5. **定期更新**：保持系统和依赖包更新
6. **备份数据**：定期备份 `output` 目录和 `data.txt`

## 十、访问服务

部署完成后，您可以通过以下方式访问：

- **直接访问**：`http://your-server-ip:5555`
- **通过 Nginx**：`http://your-domain.com` 或 `https://your-domain.com`（如果配置了 SSL）

## 总结

完成以上步骤后，您的 WeekReportImg 服务应该已经成功部署并运行在服务器上。服务会在系统启动时自动启动，并在崩溃时自动重启。

如有问题，请查看日志文件或联系技术支持。
